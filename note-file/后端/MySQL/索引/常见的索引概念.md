

> #### 索引按物理实现方式，索引可以分为两种：聚簇（聚集）和非聚簇（非聚集）索引。我们也把非聚簇索引称为二级索引或者辅助索引





## 聚簇索引



#### 聚簇索引并不是一种单独的索引类型，而是一种数据存储方式（所有的用户记录都存储在叶子节点），也就是所谓的索引即数据，数据即索引。

> #### 术语：聚簇 表示数据行和相邻的键值聚簇的存储在一起



#### 特点：

- ##### 使用记录主键值的大小进行记录和页的排序，这包括三个方面的含义：

  - ##### <font color='red'>页内</font>的记录是按照主键的大小顺序排成一个<font color='red'>单向链表</font>

  - ##### 各个存放<font color='red'>用户记录的页</font>也是根据业种用户记录的主键大小顺序排成一个<font color='red'>双向链表</font>
  
  - ##### 存放<font color='red'>目录项记录的页</font>分为不同的层次，在同一层次种的页也是根据页中目录记录的主键大小顺序排成的一个<font color='red'>双向链表</font>
  
- ##### B+树的叶子节点存储的是完成的用户信息

  - ##### 所谓完整的用户记录，就是指这个记录种存储了所有列的值（包括隐藏列）


#### 我们把具有以上两种特性的B+树称为<font color='red'>聚簇索引</font>，所有完整的用户记录都存放在这个聚簇索引的叶子节点处。这种聚簇索引并不需要我们在MySQL中显示的使用<font color='red'>INDEX</font>语句去创建，InnoDB存储引擎会<font color='red'>自动</font>的为我们创建聚簇。索引



#### 优点：

- ##### 数据访问更快，因为聚簇索引将索引和数据保存在同一个b+树，因此聚簇索引种获取数据比非聚簇索引更快

- ##### 聚簇索引对于主键的<font color='red'>排序查找</font>和<font color='red'>范围查找</font>速度非常快

- ##### 按照聚簇索引排序顺序，查询一定范围数据的时候，由于数据都是紧密连接，数据库不用从多个数据块中提取数据，所以<font color='red'>节省了大量的io操作</font>



#### 缺点：

- ##### 插入速度严重依赖插入顺序，按照主键的顺序插入是最快的方式，否则将出现页分裂，严重影响性能，因此，对于InnoDB我们一般定义一个<font color='red'>自增的ID列为主键</font>

- ##### <font color='red'>更新主键的代价很高</font>，因为会导致被更新的行移动，因此，对于InnoDB表，我们一般定义 <font color='red'>主键不可更新</font>

- ##### <font color='red'>二级索引访问需要两次索引查找</font>，第一次找到主键值，第二次根据主键值找到行数据



#### 限制

- ##### 对于MySQL数据库目前只有InnoDB数据引擎支持聚簇索引，而MyISAM并不支持聚簇索引。

- ##### 由于数据物理存储排序方式只有一种，所以每个MySQL的表只能有一个聚簇索引，一般情况下就是该表的主键。

- ##### 如果没有定于主键，InnoDB会选择<font color='red'>非空的唯一索引</font>代替，如果没有这样的索引，InnoDB会隐式的定义一个主键来作为聚簇索引（row-id）

- ##### 为了充分利用聚簇索引的聚簇的特性，所以InnoDB表的主键应该选择<font color='red'>有序的顺序id</font>









## 二级索引（辅助索引、非聚簇索引）



#### 聚簇索引索引只能在搜索条件为主键的时候才能发挥作用，因为B+树中的数据都是按照主键进行排序的。如果需要以别的列为搜索条件可以<font color='red'>多建几颗B+树</font>，不同的B+树采用不同的排序顺序。



#### B+树设计

> ##### 推演见 InnoDB中索引的推演，其推演和聚簇类似。



##### 在叶子节点，聚簇索引会包含行数据。而在二级索引中，叶子节点会保存作为搜索条件的列的数据，一样会按顺序保存；并且叶子节点不单单只会保存搜索条件的列的数据，还会保存<font color='red'>主键的值（聚簇索引的值）</font>。

- ##### 若需要查询行其他列的数据，系统会通过主键的值进行聚簇索引查找，找到该行的其他数据，这个过程称为<font color='red'>回表</font> 







## 小结



- ##### 聚簇索引的叶子节点存储的是完整的数据记录，非聚簇索引的叶子节点存储的是数据位置。非聚簇索引不会影响数据表的物理存储顺序。

- ##### 一个表只能又一个聚簇索引，因为只能有一种排序存储的方式，但可以有多个非聚簇索引，也就是多个索引目录提供数据检索。

- ##### 使用聚簇索引的时候，数据的查询效率高，但如果对数据进行插入、删除、更新等操作，效率会比非聚簇索引低

